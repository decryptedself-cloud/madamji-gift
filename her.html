<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROJECT: CELESTIAL</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;500;700&family=Cinzel:wght@400;700&family=Alex+Brush&display=swap');

        :root {
            --bg: #040406;
            --cyan: #00f3ff;
            --gold: #ffd700;
            --rose: #ff0055;
            --glass: rgba(12, 12, 20, 0.9);
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; background-color: var(--bg); color: white;
            font-family: 'Rajdhani', sans-serif; overflow: hidden;
            height: 100vh; user-select: none; touch-action: none;
        }

        /* CANVAS */
        canvas { position: fixed; inset: 0; z-index: 1; transition: filter 0.8s; }
        .blur { filter: blur(8px) brightness(0.6); }

        /* LOADING SCREEN */
        #loader {
            position: fixed; inset: 0; z-index: 1000; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .loader-ring {
            width: 50px; height: 50px; border: 2px solid #333; border-top: 2px solid var(--cyan);
            border-radius: 50%; animation: spin 1s infinite linear;
        }
        .loader-text { margin-top: 15px; font-size: 12px; letter-spacing: 2px; color: var(--cyan); }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HUD */
        #ui-layer {
            position: fixed; inset: 0; z-index: 10; pointer-events: none;
            padding: 20px; display: flex; flex-direction: column; justify-content: space-between;
        }
        .hud-text { font-size: 10px; color: rgba(255,255,255,0.4); letter-spacing: 1px; }

        /* DOCK */
        .dock {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; z-index: 50; pointer-events: auto;
            background: rgba(0,0,0,0.7); padding: 12px 30px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(12px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: transform 0.3s;
        }
        .dock.hidden { transform: translateX(-50%) translateY(100px); }

        .dock-btn {
            background: transparent; border: none; color: #888;
            font-size: 24px; cursor: pointer; transition: 0.3s; position: relative;
        }
        .dock-btn:hover, .dock-btn.active { color: var(--cyan); transform: scale(1.2); }
        .dock-btn.gold { color: var(--gold); }

        /* MODALS */
        .modal {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 85%; max-width: 500px;
            background: var(--glass);
            border: var(--border); border-top: 2px solid var(--cyan);
            padding: 30px; opacity: 0; pointer-events: none;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 40; display: flex; flex-direction: column;
            box-shadow: 0 20px 80px rgba(0,0,0,0.8); border-radius: 12px;
        }
        .modal.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;
            font-family: 'Rajdhani'; text-transform: uppercase; color: var(--cyan); letter-spacing: 2px;
        }

        /* LETTER */
        .scroll-content { max-height: 55vh; overflow-y: auto; padding-right: 5px; }
        .letter-body { font-size: 1.1rem; line-height: 1.6; color: #ddd; white-space: pre-wrap; }
        .highlight { color: var(--gold); font-weight: 700; text-shadow: 0 0 10px rgba(255,215,0,0.2); }
        .memory { color: var(--cyan); font-style: italic; border-bottom: 1px dashed var(--cyan); }
        .signature { font-family: 'Alex Brush', cursive; font-size: 1.5rem; text-align: right; margin-top: 20px; color: var(--gold); }

        /* VIP SCRATCH */
        .scratch-area {
            position: relative; width: 100%; height: 220px; margin-top: 20px;
            border-radius: 10px; overflow: hidden; border: 2px solid var(--gold);
        }
        .ticket-content {
            position: absolute; inset: 0; background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        canvas.scratch-canvas { position: absolute; inset: 0; z-index: 2; cursor: pointer; }

        /* BUTTONS */
        .action-btn {
            margin-top: 20px; background: rgba(0,243,255,0.1); border: 1px solid var(--cyan);
            color: var(--cyan); padding: 12px; font-family: 'Rajdhani'; font-weight: bold;
            cursor: pointer; width: 100%; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px;
        }
        
        /* GAME UI */
        #game-ui {
            position: fixed; inset: 0; pointer-events: none; z-index: 30;
            display: none; flex-direction: column; align-items: center; padding-top: 60px;
        }
        .score { font-size: 60px; font-weight: 700; color: var(--gold); text-shadow: 0 0 30px var(--gold); }
        .exit-game-btn {
            pointer-events: auto; margin-top: 20px; border: 1px solid #fff; color: #fff;
            background: rgba(0,0,0,0.5); padding: 8px 20px; font-size: 12px; cursor: pointer;
        }

    </style>
</head>
<body>

    <canvas id="cosmos"></canvas>

    <!-- LOADING -->
    <div id="loader">
        <div class="loader-ring"></div>
        <div class="loader-text">INITIALIZING...</div>
    </div>

    <!-- HUD -->
    <div id="ui-layer">
        <div class="hud-text">SYS: CELESTIAL<br>AUDIO: ACTIVE</div>
        <div class="hud-text" style="text-align: right;">USER: MADAMJI<br>STATUS: LOVED</div>
    </div>

    <!-- DOCK -->
    <div class="dock" id="main-dock">
        <button class="dock-btn" onclick="openModal('letter')">ðŸ“©</button>
        <button class="dock-btn" onclick="setMode('orbit')">âš›</button>
        <button class="dock-btn" onclick="startGame()">ðŸ•¹</button>
        <button class="dock-btn gold" onclick="openModal('vip')">ðŸ‘‘</button>
    </div>

    <!-- LETTER -->
    <div class="modal" id="modal-letter">
        <div class="modal-header">
            <span>> DECRYPTED_MESSAGE</span>
            <span style="cursor:pointer" onclick="closeAll()">âœ•</span>
        </div>
        <div class="scroll-content">
            <div class="letter-body" id="letter-text"></div>
            <div class="signature">Yours, Always.</div>
        </div>
        <button class="action-btn" onclick="openModal('vip')">CLAIM GIFT</button>
    </div>

    <!-- VIP -->
    <div class="modal" id="modal-vip" style="border-top: 2px solid var(--gold);">
        <div class="modal-header" style="color:var(--gold)">
            <span>> ROYAL_VAULT</span>
            <span style="cursor:pointer" onclick="closeAll()">âœ•</span>
        </div>
        <div style="text-align:center;">
            <p style="font-size:12px; color:#aaa; margin-bottom:10px;">SCRATCH SCREEN TO REVEAL</p>
            <div class="scratch-area" id="scratch-container">
                <div class="ticket-content">
                    <div style="font-size:30px; margin-bottom:10px;">ðŸ‘‘</div>
                    <div style="font-family:'Cinzel'; font-size:24px; color:var(--gold);">VIP PASS</div>
                    <div style="font-size:12px; color:#888; margin-top:5px;">ADMIT ONE: MADAMJI</div>
                    <div style="font-size:14px; margin-top:10px; color:var(--cyan);">EXCLUSIVE DATE NIGHT</div>
                    <div style="margin-top:20px; border:1px dashed var(--gold); padding:5px 15px; font-size:18px; color:var(--gold);">YES-DAY-01</div>
                </div>
                <canvas class="scratch-canvas" id="scratch-layer"></canvas>
            </div>
        </div>
        <button class="action-btn" style="border-color:var(--gold); color:var(--gold); margin-top:20px;" onclick="alert('Screenshot this!')">SAVE TICKET</button>
    </div>

    <!-- GAME -->
    <div id="game-ui">
        <div class="score" id="score-display">0</div>
        <div style="color:#888; font-size:12px; margin-top:5px; letter-spacing:2px;">DRAG TO COLLECT STARS</div>
        <button class="exit-game-btn" onclick="closeAll()">EXIT GAME</button>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            if (type === 'hover') {
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'success') {
                osc.frequency.setValueAtTime(880, now); 
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }

        // --- CONTENT ---
        const message = `Happy Birthday, Madamji.

I wanted to build a world that pauses time, just for you.

You hold a very special place in my heart. <span class="highlight">Seeing you cry on your birthday felt like a glitch in the universe.</span> I don't know the reason, and I won't pry, but seeing your light dim broke me.

I miss the simple moments. <span class="memory">Like sitting on those chairs after sports, talking about DMUN...</span> The noise faded, and it was just us.

My wish for you:
Deep healing.
Infinite Joy.
And a life as bright as these stars.

I also have a surprise for you.
Check the <span class="highlight">Royal Vault</span> (Crown Icon).

<span class="highlight">â€” For your eyes only.</span>`;

        // --- ENGINE ---
        const canvas = document.getElementById('cosmos');
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];
        let mouse = { x: 0, y: 0, active: false };
        let mode = 'orbit'; 
        let gameActive = false, score = 0, items = [];

        window.onload = () => {
            resize(); initParticles();
            setTimeout(() => {
                document.getElementById('loader').style.opacity = 0;
                setTimeout(() => { 
                    document.getElementById('loader').style.display = 'none';
                    openModal('letter'); 
                }, 500);
            }, 1500);
            loop();
        };

        window.addEventListener('resize', resize);
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }

        // INPUT FIX: Added TouchMove
        const handleMove = (x, y) => { mouse.x = x; mouse.y = y; };
        window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
        window.addEventListener('mousedown', () => mouse.active = true);
        window.addEventListener('mouseup', () => mouse.active = false);
        window.addEventListener('touchstart', e => { 
            handleMove(e.touches[0].clientX, e.touches[0].clientY); mouse.active = true; 
        });
        window.addEventListener('touchmove', e => { 
            handleMove(e.touches[0].clientX, e.touches[0].clientY); // FIX FOR GAME
        });
        window.addEventListener('touchend', () => mouse.active = false);

        // --- PARTICLES ---
        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * width; this.y = Math.random() * height;
                this.vx = (Math.random()-0.5)*0.5; this.vy = (Math.random()-0.5)*0.5;
                this.size = Math.random() * 2;
                this.color = Math.random() > 0.9 ? '#fff' : '#00f3ff';
            }
            update() {
                if(mouse.active && mode === 'orbit') {
                    const dx = mouse.x - this.x; const dy = mouse.y - this.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const force = 500 / (dist + 50);
                    const angle = Math.atan2(dy, dx);
                    this.vx += Math.cos(angle) * force * 0.05;
                    this.vy += Math.sin(angle) * force * 0.05;
                }
                if(mode === 'game') this.vy += 3; 

                this.x += this.vx; this.y += this.vy;
                this.vx *= 0.96; this.vy *= 0.96;
                
                if(this.x<0) this.x=width; if(this.x>width) this.x=0;
                if(this.y<0) this.y=height; if(this.y>height) this.y=0;
            }
            draw() {
                ctx.fillStyle = this.color; ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }
        function initParticles() { for(let i=0; i<1200; i++) particles.push(new Particle()); }

        // --- SCRATCH CARD ---
        function initScratch() {
            const sc = document.getElementById('scratch-layer');
            const scCtx = sc.getContext('2d');
            const container = document.getElementById('scratch-container');
            sc.width = container.clientWidth; sc.height = container.clientHeight;

            scCtx.fillStyle = '#ffd700'; scCtx.fillRect(0, 0, sc.width, sc.height);
            scCtx.fillStyle = '#000'; scCtx.font = "20px Rajdhani"; scCtx.textAlign = "center";
            scCtx.fillText("SCRATCH HERE", sc.width/2, sc.height/2);

            let isDrawing = false;
            const scratch = (x, y) => {
                scCtx.globalCompositeOperation = 'destination-out';
                scCtx.beginPath(); scCtx.arc(x, y, 20, 0, Math.PI*2); scCtx.fill();
            };
            const getPos = (e) => {
                const rect = sc.getBoundingClientRect();
                return { x: (e.touches?e.touches[0].clientX:e.clientX) - rect.left, y: (e.touches?e.touches[0].clientY:e.clientY) - rect.top };
            };

            const start = (e) => { isDrawing=true; scratch(getPos(e).x, getPos(e).y); };
            const move = (e) => { if(isDrawing) scratch(getPos(e).x, getPos(e).y); };
            const end = () => isDrawing=false;

            sc.addEventListener('mousedown', start); sc.addEventListener('mousemove', move); sc.addEventListener('mouseup', end);
            sc.addEventListener('touchstart', start); sc.addEventListener('touchmove', move); sc.addEventListener('touchend', end);
        }

        // --- GAME LOGIC ---
        function startGame() {
            closeAll(); mode='game'; gameActive=true; score=0; items=[];
            document.getElementById('game-ui').style.display='flex';
            document.getElementById('score-display').innerText=0;
            document.getElementById('main-dock').classList.add('hidden');
        }
        function updateGame() {
            if(Math.random()<0.03) items.push({x:Math.random()*width, y:-20, type:'gold'});
            if(Math.random()<0.01) items.push({x:Math.random()*width, y:-20, type:'red'});
            
            // Draw Player Halo
            ctx.beginPath(); ctx.arc(mouse.x, mouse.y, 25, 0, Math.PI*2);
            ctx.strokeStyle='#00f3ff'; ctx.lineWidth=2; ctx.stroke();

            for(let i=0; i<items.length; i++) {
                let p = items[i]; p.y += 5;
                ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2);
                ctx.fillStyle = p.type==='gold'?'#ffd700':'#ff0055'; ctx.fill();
                
                if(Math.hypot(mouse.x-p.x, mouse.y-p.y) < 35) {
                    if(p.type==='gold') { score+=100; playSound('success'); } 
                    else score-=50;
                    document.getElementById('score-display').innerText = score;
                    items.splice(i,1); i--;
                } else if(p.y > height) { items.splice(i,1); i--; }
            }
        }

        // --- MODAL SYSTEM ---
        let typeInterval;
        function openModal(id) {
            closeAll();
            document.getElementById('modal-'+id).classList.add('active');
            document.getElementById('cosmos').classList.add('blur');
            
            if(id === 'letter') {
                const el = document.getElementById('letter-text');
                el.innerHTML = ''; let i=0;
                clearInterval(typeInterval);
                typeInterval = setInterval(() => {
                    if(i < message.length) {
                        let c = message.charAt(i);
                        el.innerHTML += (c === '\n' ? '<br>' : c); i++;
                        document.querySelector('.scroll-content').scrollTop = 10000;
                    } else clearInterval(typeInterval);
                }, 20);
            }
            if(id === 'vip') setTimeout(initScratch, 100);
        }

        function closeAll() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            document.getElementById('cosmos').classList.remove('blur');
            document.getElementById('game-ui').style.display='none';
            document.getElementById('main-dock').classList.remove('hidden');
            mode = 'orbit'; gameActive = false;
        }
        
        function setMode(m) { closeAll(); mode = m; }

        function loop() {
            ctx.fillStyle = 'rgba(4,4,6,0.3)'; ctx.fillRect(0,0,width,height);
            particles.forEach(p => { p.update(); p.draw(); });
            if(gameActive) updateGame();
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>